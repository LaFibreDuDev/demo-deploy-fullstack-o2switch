"use strict";const g=require("express"),v=require("cookie-parser"),u=require("zod"),S=require("node:util"),A=require("jsonwebtoken"),p=require("sequelize"),P=require("jwt-decode"),k={host:process.env.HOST||"localhost",port:process.env.PORT||3e3,secure:process.env.SECURE||!1},O={dialect:process.env.DATABASE_DIALECT||"sqlite",storage:process.env.DATABASE_STORAGE||"database.sqlite"},N={accessToken:{type:process.env.ACCESS_TOKEN_TYPE||"Bearer",algorithm:process.env.ACCESS_TOKEN_ALGORITHM||"HS256",secret:process.env.ACCESS_TOKEN_SECRET||"Acc3ssTok3nS3c3t!",expiresIn:process.env.ACCESS_TOKEN_EXPIRES_IN_MS||60*60*1e3,audience:process.env.ACCESS_TOKEN_AUDIENCE||"my_backend_api",issuer:process.env.ACCESS_TOKEN_ISSUER||"my_authentication_server"},crypto:{scrypt:{saltLength:process.env.SCRYPT_SALT_LENGTH||16,hashLength:process.env.SCRYPT_HASH_LENGTH||64,cost:process.env.SCRYPT_COST||Math.pow(2,17),blockSize:process.env.SCRYPT_BLOCK_SIZE||8,parallelization:process.env.SCRYPT_PARALLELIZATION||1,maxmem:process.env.SCRYPT_MAXMEM|134220800},unsaltedHashAlgorithm:process.env.FAST_HASH_ALGORITHM||"sha256"}},d={auth:N,database:O,server:k},f={};async function R(s){const e=S.promisify(f.scrypt),{saltLength:t,hashLength:n,cost:c,blockSize:r,parallelization:o,maxmem:l}=d.auth.crypto.scrypt,i=f.randomBytes(t).toString("hex");return`${(await e(s,i,n,{cost:c,blockSize:r,parallelization:o,maxmem:l})).toString("hex")}.${i}`}async function I(s,e){const[t,n]=e.split("."),c=Buffer.from(t,"hex"),r=S.promisify(f.scrypt),{hashLength:o,cost:l,blockSize:i,parallelization:m,maxmem:_}=d.auth.crypto.scrypt,w=await r(s,n,o,{cost:l,blockSize:i,parallelization:m,maxmem:_});return f.timingSafeEqual(c,w)}const{algorithm:E,audience:z,expiresIn:h,issuer:j,secret:y,type:b}=d.auth.accessToken;function L(s){const e={id:s.id,username:s.username};return{accessToken:{token:q(e),type:b,expiresAt:B(h),expiresInMS:h}}}function q(s){return A.sign(s,y,{algorithm:E,audience:z,expiresIn:h,issuer:j})}function x(s){try{return A.verify(s,y,{algorithms:E})}catch(e){return console.error(e),null}}function B(s){return new Date(new Date().valueOf()+s)}const{dialect:D,storage:H}=d.database,M=new p.Sequelize({dialect:D,storage:H});class T extends p.Model{}T.init({username:{type:p.DataTypes.STRING},email:{type:p.DataTypes.STRING,unique:!0},password:{type:p.DataTypes.STRING}},{sequelize:M});async function G(s,e){const{data:t,error:n}=await Y().safeParseAsync(s.body);if(n)return e.status(400).json({status:400,message:n.message});const{username:c,email:r,password:o}=t;if(await T.count({where:{email:r}})!==0)return e.status(409).json({status:409,message:"Provided email already in use"});await T.create({username:c,email:r,password:await R(o)}),e.status(201).json({status:201,message:"User successfully created"})}async function K(s,e){const{data:t,error:n}=await $().safeParseAsync(s.body);if(n)return e.status(400).json({status:400,message:n.message});const{email:c,password:r}=t,o=await T.findOne({where:{email:c}});if(!o)return e.status(401).json({status:401,message:"Bad credentials"});if(!await I(r,o.password))return e.status(401).json({status:401,message:"Bad credentials"});const{accessToken:i}=L(o);console.log("CSRF TOKEN GENERE PENDANT LA CONNEXION"),console.log(i),J(e,{user:o,accessToken:i})}async function U(s,e){e.status(204).json({status:204,message:"Successfully logged out"})}function Y(){return u.z.object({username:u.z.string().min(1),email:u.z.string().min(1).email(),password:u.z.string().min(8)})}function $(){return u.z.object({email:u.z.string().email(),password:u.z.string()})}function J(s,{user:e,accessToken:t,refreshToken:n,csrfToken:c}){s.json({username:e.username,accessToken:t.token,accessTokenType:t.type,accessTokenExpiresAt:t.expiresAt})}typeof PhusionPassenger<"u"&&PhusionPassenger.configure({autoInstall:!1});const a=g();a.use("/",g.static("client"));a.use(g.urlencoded({extended:!0}));a.use(g.json());a.use((s,e,t)=>{e.header("Access-Control-Allow-Origin","http://localhost:5173"),e.header("Access-Control-Allow-Headers","Content-Type, Accept, Authorization"),e.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),e.header("Access-Control-Allow-Credentials",!0),s.method==="OPTIONS"?e.sendStatus(200):t()});a.use(v());a.post("/signup",G);a.post("/login",K);a.delete("/logout",U);a.get("/public-stuff",W);a.get("/private-stuff",C,X);a.get("/profile",C,Z);if(typeof PhusionPassenger<"u")a.listen("passenger");else{const{port:s,host:e}=d.server;a.listen(s,e,()=>{console.log(`ðŸš€ Server listening on http://${e}:${s}`)})}function C(s,e,t){var r,o;console.log("Traitement de la requÃªte en cours ...");const n=(o=(r=s.headers)==null?void 0:r.authorization)==null?void 0:o.split("Bearer ")[1];if(!n)return e.status(401).json({status:401,message:"No access token provided in request headers"});if(console.log("VÃ©rification du token en cours ..."),!x(n))return e.status(401).json({status:401,message:"Invalid access token"});console.log("Requete acceptÃ©e (JWT TOKEN)"),s.accessToken=n,t()}function W(s,e){e.json({status:200,message:"This is some public resource."})}function X(s,e){console.log(`JWT rÃ©cupÃ©rÃ© depuis la requÃªte : ${s.accessToken}`),console.log(`RÃ©cupÃ©ration de l'id : ${P.jwtDecode(s.accessToken).id}`),e.status(200).json({status:200,message:"This is some private resource"})}function Z(s,e){const t={address:{lastname:"DARK",firstname:"Enzo",streetAddress:"1 rue du fleuve",postCode:"57000",city:"METZ"}};e.status(200).json({status:200,data:t})}
