"use strict";const f=require("express"),I=require("cookie-parser"),b=require("dotenv"),j=require("node:crypto"),C=require("jsonwebtoken"),B=require("jwt-decode"),w=require("swagger-ui-express"),L=require("swagger-jsdoc"),g=require("zod"),R=require("node:util"),u=require("sequelize");b.config();const q={url:process.env.SERVER_URL||`http://localhost:${process.env.PORT||3e3}`,host:process.env.HOST||"0.0.0.0",port:process.env.PORT||3e3,secure:process.env.SECURE||!1,cors:process.env.CORS||""},z={dialect:process.env.DATABASE_DIALECT||"postgres",database:process.env.DATABASE_DBNAME,user:process.env.DATABASE_USER,password:process.env.DATABASE_PASSWORD,host:process.env.DATABASE_HOST,port:process.env.DATABASE_PORT,ssl:process.env.DATABASE_SSL||!1},U={accessToken:{type:process.env.ACCESS_TOKEN_TYPE||"Bearer",algorithm:process.env.ACCESS_TOKEN_ALGORITHM||"HS256",secret:process.env.ACCESS_TOKEN_SECRET||"Acc3ssTok3nS3c3t!",expiresIn:process.env.ACCESS_TOKEN_EXPIRES_IN_MS||60*60*1e3,audience:process.env.ACCESS_TOKEN_AUDIENCE||"my_backend_api",issuer:process.env.ACCESS_TOKEN_ISSUER||"my_authentication_server"},crypto:{scrypt:{saltLength:process.env.SCRYPT_SALT_LENGTH||16,hashLength:process.env.SCRYPT_HASH_LENGTH||64,cost:process.env.SCRYPT_COST||Math.pow(2,17),blockSize:process.env.SCRYPT_BLOCK_SIZE||8,parallelization:process.env.SCRYPT_PARALLELIZATION||1,maxmem:process.env.SCRYPT_MAXMEM|134220800},unsaltedHashAlgorithm:process.env.FAST_HASH_ALGORITHM||"sha256"}},p={auth:U,database:z,server:q},{algorithm:O,audience:x,expiresIn:P,issuer:M,secret:k,type:H}=p.auth.accessToken;function $(r){const s={id:r.id,username:r.username};return{accessToken:{token:G(s),type:H,expiresAt:Y(P),expiresInMS:P}}}function G(r){return C.sign(r,k,{algorithm:O,audience:x,expiresIn:P,issuer:M})}function K(r){try{return C.verify(r,k,{algorithms:O})}catch(s){return console.error(s),null}}function Y(r){return new Date(new Date().valueOf()+r)}async function J(r){const s=R.promisify(j.scrypt),{saltLength:e,hashLength:t,cost:o,blockSize:c,parallelization:n,maxmem:a}=p.auth.crypto.scrypt,l=j.randomBytes(e).toString("hex");return`${(await s(r,l,t,{cost:o,blockSize:c,parallelization:n,maxmem:a})).toString("hex")}.${l}`}async function W(r,s){const[e,t]=s.split("."),o=Buffer.from(e,"hex"),c=R.promisify(j.scrypt),{hashLength:n,cost:a,blockSize:l,parallelization:d,maxmem:y}=p.auth.crypto.scrypt,E=await c(r,t,n,{cost:a,blockSize:l,parallelization:d,maxmem:y});return j.timingSafeEqual(o,E)}const{dialect:X,database:Z,user:F,password:V,host:Q,port:ee}=p.database,D=new u.Sequelize({dialect:X,database:Z,username:F,password:V,host:Q,port:ee,ssl:!1,clientMinMessages:"notice"});class S extends u.Model{}S.init({username:{type:u.DataTypes.STRING},email:{type:u.DataTypes.STRING,unique:!0},password:{type:u.DataTypes.STRING}},{sequelize:D,timestamps:!0,tableName:"Users"});class v{static async signupUser(s,e){const{data:t,error:o}=await se().safeParseAsync(s.body);if(o)return e.status(400).json({status:400,message:o.message});const{username:c,email:n,password:a}=t;if(await S.count({where:{email:n}})!==0)return e.status(409).json({status:409,message:"Provided email already in use"});await S.create({username:c,email:n,password:await J(a)}),e.status(201).json({status:201,message:"User successfully created"})}static async loginUser(s,e){const{data:t,error:o}=await te().safeParseAsync(s.body);if(o)return e.status(400).json({status:400,message:o.message});const{email:c,password:n}=t,a=await S.findOne({where:{email:c}});if(!a)return e.status(401).json({status:401,message:"Bad credentials"});if(!await W(n,a.password))return e.status(401).json({status:401,message:"Bad credentials"});const{accessToken:d}=$(a);console.log("CSRF TOKEN GENERE PENDANT LA CONNEXION"),console.log(d),re(e,{user:a,accessToken:d})}static async logout(s,e){e.status(204).json({status:204,message:"Successfully logged out"})}}function se(){return g.z.object({username:g.z.string().min(1),email:g.z.string().min(1).email(),password:g.z.string().min(8)})}function te(){return g.z.object({email:g.z.string().email(),password:g.z.string()})}function re(r,{user:s,accessToken:e,refreshToken:t,csrfToken:o}){r.json({username:s.username,accessToken:e.token,accessTokenType:e.type,accessTokenExpiresAt:e.expiresAt})}const A=f();A.post("/signup",v.signupUser);A.post("/login",v.loginUser);A.delete("/logout",v.logout);class m extends u.Model{}m.init({name:{type:u.DataTypes.STRING},description:{type:u.DataTypes.STRING},image:{type:u.DataTypes.STRING}},{sequelize:D,tableName:"Projects"});class T{static async getAllProjects(s,e){try{const t=await m.findAll();e.status(200).json(t)}catch(t){console.error("Error fetching projects:",t),e.status(500).json({error:"An error occurred while fetching projects."})}}static async getProjectById(s,e){const{id:t}=s.params;try{const o=await m.findByPk(t);if(!o)return e.status(404).json({error:"Project not found."});e.status(200).json(o)}catch(o){console.error(`Error fetching project with ID ${t}:`,o),e.status(500).json({error:"An error occurred while fetching the project."})}}static async addProject(s,e){try{const{name:t,description:o,image:c}=s.body;if(!t)return e.status(400).json({error:'Le champ "name" est obligatoire.'});const n=await m.create({name:t,description:o,image:c});return e.status(201).json({message:"Projet cr√©√© avec succ√®s !",project:n})}catch(t){return console.error("Erreur lors de la cr√©ation du projet :",t),e.status(500).json({error:"Une erreur est survenue lors de la cr√©ation du projet."})}}static async updateProject(s,e){try{const{id:t}=s.params,{name:o,description:c,image:n}=s.body,a=await m.findByPk(t);return a?(await a.update({name:o,description:c,image:n}),e.status(200).json({message:"Projet mis √† jour avec succ√®s !",project:a})):e.status(404).json({error:"Projet non trouv√©."})}catch(t){return console.error("Erreur lors de la mise √† jour du projet :",t),e.status(500).json({error:"Une erreur est survenue lors de la mise √† jour du projet."})}}static async deleteProject(s,e){try{const{id:t}=s.params,o=await m.findByPk(t);return o?(await o.destroy(),e.status(200).json({message:"Projet supprim√© avec succ√®s !"})):e.status(404).json({error:"Projet non trouv√©."})}catch(t){return console.error("Erreur lors de la suppression du projet :",t),e.status(500).json({error:"Une erreur est survenue lors de la suppression du projet."})}}}const h=f();h.get("/",T.getAllProjects);h.get("/:id",T.getProjectById);h.post("/",T.addProject);h.put("/:id",T.updateProject);h.delete("/:id",T.deleteProject);typeof PhusionPassenger<"u"&&PhusionPassenger.configure({autoInstall:!1});const i=f();i.use("/",f.static("client"));const{url:_,cors:oe}=p.server,ne={swaggerDefinition:{openapi:"3.0.0",info:{title:"API Documentation",version:"1.0.0",description:"Documentation interactive pour mon API"},servers:[{url:_,description:`API Serveur - ${_}`}]},apis:["./src/routes/*.js"]},ae=L(ne);i.use("/api-docs",w.serve,w.setup(ae));i.use(f.urlencoded({extended:!0}));i.use(f.json());i.use((r,s,e)=>{s.header("Access-Control-Allow-Origin",[oe]),s.header("Access-Control-Allow-Headers","Content-Type, Accept, Authorization"),s.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),s.header("Access-Control-Allow-Credentials",!0),r.method==="OPTIONS"?s.sendStatus(200):e()});i.use(I());i.get("/config",(r,s)=>{const{dialect:e,database:t,user:o,_:c,dbhost:n}=p.database,{url:a,host:l,port:d,secure:y,cors:E}=p.server;s.status(200).json({url:a,host:l,port:d,secure:y,cors:E,dialect:e,database:t,user:o,dbhost:n})});i.use("/auth",A);i.use("/projects",h);i.get("/public-stuff",ce);i.get("/private-stuff",N,ie);i.get("/profile",N,ue);if(typeof PhusionPassenger<"u")i.listen("passenger");else{const{port:r,host:s}=p.server;i.listen(r,s,()=>{console.log(`üöÄ Server listening on http://${s}:${r}`)})}function N(r,s,e){var c,n;console.log("Traitement de la requ√™te en cours ...");const t=(n=(c=r.headers)==null?void 0:c.authorization)==null?void 0:n.split("Bearer ")[1];if(!t)return s.status(401).json({status:401,message:"No access token provided in request headers"});if(console.log("V√©rification du token en cours ..."),!K(t))return s.status(401).json({status:401,message:"Invalid access token"});console.log("Requete accept√©e (JWT TOKEN)"),r.accessToken=t,e()}function ce(r,s){s.json({status:200,message:"This is some public resource."})}function ie(r,s){console.log(`JWT r√©cup√©r√© depuis la requ√™te : ${r.accessToken}`),console.log(`R√©cup√©ration de l'id : ${B.jwtDecode(r.accessToken).id}`),s.status(200).json({status:200,message:"This is some private resource"})}function ue(r,s){const e={address:{lastname:"DARK",firstname:"Enzo",streetAddress:"1 rue du fleuve",postCode:"57000",city:"METZ"}};s.status(200).json({status:200,data:e})}
