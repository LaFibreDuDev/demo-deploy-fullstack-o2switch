"use strict";const d=require("express"),E=require("cookie-parser"),a=require("./project-CWzWh1xq.cjs");require("node:crypto");const w=require("jsonwebtoken"),S=require("jwt-decode"),j=require("swagger-ui-express"),v=require("swagger-jsdoc"),u=require("zod"),{algorithm:T,audience:b,expiresIn:p,issuer:O,secret:y,type:D}=a.config.auth.accessToken;function q(t){const e={id:t.id,username:t.username};return{accessToken:{token:C(e),type:D,expiresAt:U(p),expiresInMS:p}}}function C(t){return w.sign(t,y,{algorithm:T,audience:b,expiresIn:p,issuer:O})}function I(t){try{return w.verify(t,y,{algorithms:T})}catch(e){return console.error(e),null}}function U(t){return new Date(new Date().valueOf()+t)}class f{static async signupUser(e,s){const{data:o,error:r}=await this.buildSignupBodySchema().safeParseAsync(e.body);if(r)return s.status(400).json({status:400,message:r.message});const{username:c,email:i,password:l}=o;if(await a.User.count({where:{email:i}})!==0)return s.status(409).json({status:409,message:"Provided email already in use"});await a.User.create({username:c,email:i,password:await a.hash(l)}),s.status(201).json({status:201,message:"User successfully created"})}static async loginUser(e,s){const{data:o,error:r}=await buildLoginBodySchema().safeParseAsync(e.body);if(r)return s.status(400).json({status:400,message:r.message});const{email:c,password:i}=o,l=await a.User.findOne({where:{email:c}});if(!l)return s.status(401).json({status:401,message:"Bad credentials"});if(!await a.compare(i,l.password))return s.status(401).json({status:401,message:"Bad credentials"});const{accessToken:m}=q(l);console.log("CSRF TOKEN GENERE PENDANT LA CONNEXION"),console.log(m),this.sendTokensResponse(s,{user:l,accessToken:m})}static async logout(e,s){s.status(204).json({status:204,message:"Successfully logged out"})}buildSignupBodySchema(){return u.z.object({username:u.z.string().min(1),email:u.z.string().min(1).email(),password:u.z.string().min(8)})}buildLoginBodySchema(){return u.z.object({email:u.z.string().email(),password:u.z.string()})}sendTokensResponse(e,{user:s,accessToken:o,refreshToken:r,csrfToken:c}){e.json({username:s.username,accessToken:o.token,accessTokenType:o.type,accessTokenExpiresAt:o.expiresAt})}}const g=d();g.post("/signup",f.signupUser);g.post("/login",f.loginUser);g.delete("/logout",f.logout);class A{static async getAllProjects(e,s){try{const o=await a.Project.findAll();s.status(200).json(o)}catch(o){console.error("Error fetching projects:",o),s.status(500).json({error:"An error occurred while fetching projects."})}}static async getProjectById(e,s){const{id:o}=e.params;try{const r=await a.Project.findByPk(o);if(!r)return s.status(404).json({error:"Project not found."});s.status(200).json(r)}catch(r){console.error(`Error fetching project with ID ${o}:`,r),s.status(500).json({error:"An error occurred while fetching the project."})}}}const h=d();h.get("/",A.getAllProjects);h.get("/:id",A.getProjectById);typeof PhusionPassenger<"u"&&PhusionPassenger.configure({autoInstall:!1});const n=d();n.use("/",d.static("client"));const z={swaggerDefinition:{openapi:"3.0.0",info:{title:"API Documentation",version:"1.0.0",description:"Documentation interactive pour mon API"},servers:[{url:"http://localhost:3000",description:"Serveur local"}]},apis:["./src/routes/*.js"]},N=v(z);n.use("/api-docs",j.serve,j.setup(N));n.use(d.urlencoded({extended:!0}));n.use(d.json());n.use((t,e,s)=>{e.header("Access-Control-Allow-Origin",["http://localhost:5173","https://backend.lafibredudev.com"]),e.header("Access-Control-Allow-Headers","Content-Type, Accept, Authorization"),e.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),e.header("Access-Control-Allow-Credentials",!0),t.method==="OPTIONS"?e.sendStatus(200):s()});n.use(E());n.use("/",g);n.use("/projects",h);n.get("/public-stuff",B);n.get("/private-stuff",P,x);n.get("/profile",P,$);if(typeof PhusionPassenger<"u")n.listen("passenger");else{const{port:t,host:e}=a.config.server;n.listen(t,e,()=>{console.log(`ðŸš€ Server listening on http://${e}:${t}`)})}function P(t,e,s){var c,i;console.log("Traitement de la requÃªte en cours ...");const o=(i=(c=t.headers)==null?void 0:c.authorization)==null?void 0:i.split("Bearer ")[1];if(!o)return e.status(401).json({status:401,message:"No access token provided in request headers"});if(console.log("VÃ©rification du token en cours ..."),!I(o))return e.status(401).json({status:401,message:"Invalid access token"});console.log("Requete acceptÃ©e (JWT TOKEN)"),t.accessToken=o,s()}function B(t,e){e.json({status:200,message:"This is some public resource."})}function x(t,e){console.log(`JWT rÃ©cupÃ©rÃ© depuis la requÃªte : ${t.accessToken}`),console.log(`RÃ©cupÃ©ration de l'id : ${S.jwtDecode(t.accessToken).id}`),e.status(200).json({status:200,message:"This is some private resource"})}function $(t,e){const s={address:{lastname:"DARK",firstname:"Enzo",streetAddress:"1 rue du fleuve",postCode:"57000",city:"METZ"}};e.status(200).json({status:200,data:s})}
